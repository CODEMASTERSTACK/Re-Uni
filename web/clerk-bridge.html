<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signing you in...</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #111; color: #eee; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
    .box { text-align: center; }
    .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: #f44; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .err { color: #f66; margin-top: 1rem; }
    a { color: #6af; }
  </style>
</head>
<body>
  <div class="box">
    <div class="spinner"></div>
    <p>Signing you in...</p>
    <p id="err" class="err" style="display:none;"></p>
    <p id="link" style="display:none;"><a id="appLink" href="/">Continue to app</a></p>
  </div>
  <!-- Clerk docs: use data-clerk-publishable-key and load from YOUR_FRONTEND_API_URL so the key is read correctly. -->
  <script
    id="clerk-script"
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_d29ya2luZy10dXJ0bGUtNzQuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://working-turtle-74.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
    type="text/javascript"
  ></script>
  <script>
    (function() {
      var appOrigin = location.origin;
      var appRoot = appOrigin + '/';
      function goToApp(jwt, name, email) {
        var params = [];
        if (jwt) params.push('__clerk_db_jwt=' + encodeURIComponent(jwt));
        if (name) params.push('__clerk_name=' + encodeURIComponent(name));
        if (email) params.push('__clerk_email=' + encodeURIComponent(email));
        var url = params.length ? (appRoot + '?' + params.join('&')) : (appRoot + (location.search || ''));
        location.replace(url);
      }
      function showErr(msg) {
        var el = document.getElementById('err');
        var linkEl = document.getElementById('link');
        if (el) { el.textContent = msg || 'Could not get session token.'; el.style.display = 'block'; }
        if (linkEl) { linkEl.style.display = 'block'; }
        var a = document.getElementById('appLink');
        if (a) a.href = appRoot;
      }
      var publishableKey = 'pk_test_d29ya2luZy10dXJ0bGUtNzQuY2xlcmsuYWNjb3VudHMuZGV2JA';
      function run() {
        if (typeof window.Clerk === 'undefined') {
          showErr('Clerk script did not load. Check the script URL and data-clerk-publishable-key.');
          return;
        }
        var clerk = window.Clerk;
        var isConstructor = typeof clerk === 'function';
        var promise;
        if (isConstructor) {
          try {
            var instance = new clerk(publishableKey);
            promise = instance.load();
            clerk = instance;
          } catch (e) {
            showErr(e && e.message ? e.message : 'Clerk init failed.');
            return;
          }
        } else {
          promise = clerk.load ? clerk.load() : Promise.resolve();
        }
        Promise.resolve(promise).then(function() {
          var session = clerk.session;
          if (!session) {
            showErr('No session after sign-in. Try again or continue to app.');
            return;
          }
          var user = session.user;
          var name = '';
          var email = '';
          if (user) {
            var first = (user.firstName != null) ? String(user.firstName) : '';
            var last = (user.lastName != null) ? String(user.lastName) : '';
            name = (first + ' ' + last).trim() || '';
            var primary = user.primaryEmailAddress;
            if (primary && primary.emailAddress) email = String(primary.emailAddress);
          }
          var getToken = session.getToken;
          if (typeof getToken !== 'function') {
            showErr('Could not get session token.');
            return;
          }
          return getToken.call(session).then(function(token) {
            if (token) goToApp(token, name, email);
          });
        }).catch(function(e) {
          showErr(e && e.message ? e.message : 'Something went wrong.');
        });
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', run);
      } else {
        run();
      }
    })();
  </script>
</body>
</html>
